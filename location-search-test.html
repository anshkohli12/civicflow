<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>CivicFlow - Location-Based Issue Search Test</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            margin: 20px;
            background-color: #f5f5f5;
        }
        .container {
            max-width: 800px;
            margin: 0 auto;
            background: white;
            padding: 20px;
            border-radius: 8px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }
        h1 {
            color: #2563eb;
            text-align: center;
        }
        .form-group {
            margin-bottom: 15px;
        }
        label {
            display: block;
            margin-bottom: 5px;
            font-weight: bold;
        }
        input, select, button {
            width: 100%;
            padding: 8px 12px;
            border: 1px solid #ddd;
            border-radius: 4px;
            font-size: 14px;
        }
        button {
            background-color: #2563eb;
            color: white;
            cursor: pointer;
            margin-top: 10px;
        }
        button:hover {
            background-color: #1d4ed8;
        }
        .result {
            margin-top: 20px;
            padding: 15px;
            border-radius: 4px;
            white-space: pre-wrap;
        }
        .success {
            background-color: #d1fae5;
            border-left: 4px solid #10b981;
        }
        .error {
            background-color: #fee2e2;
            border-left: 4px solid #ef4444;
        }
        .issue-card {
            border: 1px solid #e5e7eb;
            border-radius: 8px;
            padding: 15px;
            margin: 10px 0;
            background: #fafafa;
        }
        .issue-title {
            font-weight: bold;
            color: #1f2937;
            font-size: 16px;
        }
        .issue-meta {
            color: #6b7280;
            font-size: 12px;
            margin-top: 5px;
        }
        .distance-badge {
            background: #3b82f6;
            color: white;
            padding: 2px 8px;
            border-radius: 12px;
            font-size: 11px;
        }
        .location-info {
            background: #eff6ff;
            padding: 10px;
            border-radius: 6px;
            margin: 10px 0;
            font-size: 12px;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>üåç Location-Based Issue Search</h1>
        
        <div class="location-info">
            <strong>üìç Popular Test Locations:</strong><br>
            ‚Ä¢ Bangalore: 12.9716, 77.5946<br>
            ‚Ä¢ Delhi: 28.6139, 77.2090<br>
            ‚Ä¢ Mumbai: 19.0760, 72.8777
        </div>

        <div class="form-group">
            <label>Latitude:</label>
            <input type="number" id="latitude" placeholder="e.g., 12.9716" step="any" value="12.9716">
        </div>

        <div class="form-group">
            <label>Longitude:</label>
            <input type="number" id="longitude" placeholder="e.g., 77.5946" step="any" value="77.5946">
        </div>

        <div class="form-group">
            <label>Search Radius (km):</label>
            <input type="number" id="radius" placeholder="e.g., 10" step="0.1" value="10">
        </div>

        <button onclick="searchNearbyIssues()">üîç Search Nearby Issues</button>
        
        <hr style="margin: 30px 0;">
        
        <h3>üéØ Advanced Search with Filters</h3>
        
        <div class="form-group">
            <label>Category (optional):</label>
            <select id="category">
                <option value="">All Categories</option>
                <option value="traffic">Traffic</option>
                <option value="sanitation">Sanitation</option>
                <option value="infrastructure">Infrastructure</option>
                <option value="environment">Environment</option>
                <option value="safety">Safety</option>
            </select>
        </div>

        <div class="form-group">
            <label>Critical Issues Only:</label>
            <select id="critical">
                <option value="">All Issues</option>
                <option value="true">Critical Only</option>
                <option value="false">Non-Critical Only</option>
            </select>
        </div>

        <button onclick="searchFilteredIssues()">üîç Search with Filters</button>
        
        <hr style="margin: 30px 0;">
        
        <h3>üìè Calculate Distance to Specific Issue</h3>
        
        <div class="form-group">
            <label>Issue ID:</label>
            <input type="number" id="issueId" placeholder="e.g., 1" value="1">
        </div>

        <button onclick="calculateDistance()">üìè Calculate Distance</button>

        <div id="result" class="result" style="display: none;"></div>
    </div>

    <script>
        const API_BASE = 'http://localhost:8080/api';

        async function searchNearbyIssues() {
            const latitude = document.getElementById('latitude').value;
            const longitude = document.getElementById('longitude').value;
            const radius = document.getElementById('radius').value || 10;

            if (!latitude || !longitude) {
                showResult('Please enter both latitude and longitude', 'error');
                return;
            }

            try {
                const response = await fetch(`${API_BASE}/issues/nearby?lat=${latitude}&lng=${longitude}&radius=${radius}`);
                const issues = await response.json();

                if (response.ok) {
                    displayIssues(issues, 'Nearby Issues');
                } else {
                    showResult(`‚ùå Error: ${issues.message || 'Unknown error'}`, 'error');
                }
            } catch (error) {
                showResult(`‚ùå Network error: ${error.message}`, 'error');
            }
        }

        async function searchFilteredIssues() {
            const latitude = document.getElementById('latitude').value;
            const longitude = document.getElementById('longitude').value;
            const radius = document.getElementById('radius').value || 10;
            const category = document.getElementById('category').value;
            const critical = document.getElementById('critical').value;

            if (!latitude || !longitude) {
                showResult('Please enter both latitude and longitude', 'error');
                return;
            }

            let url = `${API_BASE}/issues/nearby/filtered?lat=${latitude}&lng=${longitude}&radius=${radius}`;
            if (category) url += `&category=${category}`;
            if (critical) url += `&critical=${critical}`;

            try {
                const response = await fetch(url);
                const issues = await response.json();

                if (response.ok) {
                    displayIssues(issues, 'Filtered Nearby Issues');
                } else {
                    showResult(`‚ùå Error: ${issues.message || 'Unknown error'}`, 'error');
                }
            } catch (error) {
                showResult(`‚ùå Network error: ${error.message}`, 'error');
            }
        }

        async function calculateDistance() {
            const latitude = document.getElementById('latitude').value;
            const longitude = document.getElementById('longitude').value;
            const issueId = document.getElementById('issueId').value;

            if (!latitude || !longitude || !issueId) {
                showResult('Please enter latitude, longitude, and issue ID', 'error');
                return;
            }

            try {
                const response = await fetch(`${API_BASE}/issues/${issueId}/distance?lat=${latitude}&lng=${longitude}`);
                const data = await response.json();

                if (response.ok) {
                    showResult(`üìè Distance Calculation Result:
                    
Issue ID: ${data.issueId}
Distance: ${data.distance} ${data.unit}
Issue Location: ${data.issueLocation.latitude}, ${data.issueLocation.longitude}`, 'success');
                } else {
                    showResult(`‚ùå Error: ${data.message || 'Unknown error'}`, 'error');
                }
            } catch (error) {
                showResult(`‚ùå Network error: ${error.message}`, 'error');
            }
        }

        function displayIssues(issues, title) {
            let html = `<h3>‚úÖ ${title} (${issues.length} found)</h3>`;
            
            if (issues.length === 0) {
                html += '<p>No issues found in the specified area.</p>';
            } else {
                issues.forEach(issue => {
                    const createdDate = new Date(issue.createdAt).toLocaleDateString();
                    const statusBadge = getStatusBadge(issue.status);
                    const criticalBadge = issue.critical ? '<span style="background: #ef4444; color: white; padding: 2px 6px; border-radius: 10px; font-size: 10px;">CRITICAL</span>' : '';
                    
                    html += `
                        <div class="issue-card">
                            <div class="issue-title">${issue.title}</div>
                            <p style="margin: 8px 0; color: #4b5563;">${issue.description}</p>
                            <div class="issue-meta">
                                üìç Location: ${issue.latitude}, ${issue.longitude} | 
                                üìÇ ${issue.category} | 
                                ${statusBadge} ${criticalBadge} |
                                üë§ Created by: ${issue.createdBy.username} |
                                üìÖ ${createdDate}
                                ${issue.imageUrl ? `| üñºÔ∏è <a href="http://localhost:8080${issue.imageUrl}" target="_blank">View Image</a>` : ''}
                            </div>
                        </div>
                    `;
                });
            }
            
            showResult(html, 'success');
        }

        function getStatusBadge(status) {
            const colors = {
                'OPEN': '#ef4444',
                'IN_PROGRESS': '#f59e0b', 
                'RESOLVED': '#10b981',
                'REJECTED': '#6b7280'
            };
            return `<span style="background: ${colors[status] || '#6b7280'}; color: white; padding: 2px 6px; border-radius: 10px; font-size: 10px;">${status}</span>`;
        }

        function showResult(message, type) {
            const resultDiv = document.getElementById('result');
            resultDiv.innerHTML = message;
            resultDiv.className = `result ${type}`;
            resultDiv.style.display = 'block';
            resultDiv.scrollIntoView({ behavior: 'smooth' });
        }
    </script>
</body>
</html>
